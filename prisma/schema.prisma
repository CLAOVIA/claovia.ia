generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== ENUMS ==============

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  MANAGER
  COLLABORATOR
}

enum ReportStatus {
  PENDING
  GENERATED
  SENT
  VIEWED
  ARCHIVED
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
}

// ============== MODELS ==============

model Organization {
  id        String   @id @default(cuid())
  name      String
  domain    String?  @unique // Pour l'auto-join (ex: @entreprise.com)
  plan      String   @default("free") // free, pro, enterprise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profiles   Profile[]
  rexReports RexReport[]

  @@map("organizations")
}

model Profile {
  id             String       @id // Correspond à auth.users.id de Supabase
  email          String       @unique
  fullName       String?
  avatarUrl      String?
  role           Role         @default(MANAGER)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  managedReports RexReport[]  @relation("ManagerReports")
  teamMembers    TeamMember[]

  @@map("profiles")
}

model TeamMember {
  id        String   @id @default(cuid())
  email     String?  // Peut être null si anonyme
  name      String?
  managerId String
  manager   Profile  @relation(fields: [managerId], references: [id])
  createdAt DateTime @default(now())

  rexEntries RexEntry[]

  @@map("team_members")
}

model RexEntry {
  id           String      @id @default(cuid())
  sessionId    String      // ID de session Typebot
  content      Json        // Réponses brutes du chatbot
  isAnonymous  Boolean     @default(false)
  teamMemberId String?
  teamMember   TeamMember? @relation(fields: [teamMemberId], references: [id])
  reportId     String?
  report       RexReport?  @relation(fields: [reportId], references: [id])
  createdAt    DateTime    @default(now())

  @@map("rex_entries")
}

model RexReport {
  id             String       @id @default(cuid())
  managerId      String
  manager        Profile      @relation("ManagerReports", fields: [managerId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  // Contenu généré par l'IA
  summary        String?      @db.Text
  themes         Json?        // Array de ThemeAnalysis
  recommendations Json?       // Array de strings
  managerKit     Json?        // { emailDraft, interviewScript, pitfalls }
  climateScore   Float?       // Score global 1-10
  
  // Métadonnées
  status         ReportStatus @default(PENDING)
  pdfUrl         String?
  viewedAt       DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  entries        RexEntry[]

  @@index([managerId])
  @@index([organizationId])
  @@index([status])
  @@map("rex_reports")
}

// ============== AUDIT LOG ==============

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // VIEW_REPORT, DOWNLOAD_PDF, etc.
  resourceId String?
  metadata   Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}
